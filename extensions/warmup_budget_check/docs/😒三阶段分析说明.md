# 😒 Phase 1 三阶段分析说明

## Step 1: 预热采样方案生成

**核心功能**: 根据设计空间和预算生成战略性采样方案

**输入**:

- 设计空间CSV（仅自变量列）
- 被试数量、每人trials数
- 是否跳过交互探索

**分析内容**:

1. **预算充足性评估** - 计算Core-1/Core-2a/Core-2b/边界点/LHS各部分所需样本数
2. **五步采样策略**:
   - Core-1: 战略性固定点（全最小/最大/中位数、奇偶交替、前后半分等8个语义点）
   - Core-2a: 主效应覆盖
   - Core-2b: 交互效应探索
   - Boundary: 单维极端点（去重）
   - LHS: 全局拉丁超立方采样填充

**输出**:

- `subject_N.csv` - 每个被试的采样配置文件
- `README.txt` - 采样说明文档
- 预算分配详情（各部分样本数、充足性评估）

---

## Step 2: Phase 1数据分析与Phase 2参数生成

**核心功能**: 从预热数据中提取关键信息，为Phase 2主动学习生成参数

**输入**:

- Phase 1实验数据CSV（含响应列）
- 被试列名、响应列名
- 交互对选择参数（max_pairs, min_pairs, selection_method）

**分析内容**:

1. **交互对筛选** - 使用三种方法综合评分：
   - 残差四象限模式分析（权重0.3）
   - BIC增益（权重0.5）
   - 方差解释增量（权重0.2）
   - 选择方法：elbow（肘部法则）/bic_threshold/top_k

2. **λ参数估计** - 主效应vs交互效应相对权重

   **数学方法**:
   - 模型1（仅主效应）: y = β₀ + Σβᵢxᵢ → R²_main
   - 模型2（完整）: y = β₀ + Σβᵢxᵢ + Σγₖ(xᵢ·xⱼ)_k → R²_full
   - 交互贡献度: Δ_int = R²_full - R²_main
   - **λ = Δ_int / R²_full**（交互对总解释方差的占比）
   - 最终λ ∈ [0.2, 0.9]（下界保证交互探索，上界防止过度）

   **方差分解**:
   - 主效应方差: σ²_main = R²_main × Var(y)
   - 交互效应方差: σ²_int = Δ_int × Var(y)
   - 残差方差: σ²_res = (1 - R²_full) × Var(y)
   - 用于诊断数据质量和模型拟合度

3. **主效应和交互效应估计** - 线性回归系数

**输出**:

- `phase1_phase2_config.json` - Phase 2配置（交互对列表、λ/γ初始值、总预算等）
- `phase1_phase2_schedules.npz` - λ/γ动态调度数组（按trial衰减）
- `phase1_analysis_report.md` - 分析报告（筛选的交互对、方差分解、效应估计）
- `phase1_usage_guide.md` - Phase 2使用指南

---

## Step 3: Base GP训练与设计空间扫描

**核心功能**: 训练Matern 2.5 + ARD基准GP，扫描设计空间并选出关键点

**输入**:

- Phase 1数据CSV（含响应列）
- 设计空间CSV（仅自变量列）
- 训练参数（迭代数、学习率、是否使用CUDA）

**分析内容**:

1. **数据预处理**:
   - 分类变量label编码、布尔变量转int
   - 被试内Z-score标准化（y → y_norm）

2. **Base GP训练**:
   - Kernel: Matern(ν=2.5) + ARD + Scale
   - 优化器: Adam
   - 记录训练历史（loss、noise、lengthscale均值）

3. **长度尺度分析** - ARD长度尺度排序，识别高/中/低敏感因子

4. **设计空间扫描** - 批量预测所有设计点的均值和标准差

5. **关键点选择**（三个采样点）:
   - Sample 1: 全局最高点（x_best_prior）
   - Sample 2: 全局最低点（x_worst_prior）
   - Sample 3: 最大不确定点（x_max_std，若方差过低则用中心点）
   - 可选多样性检查：确保Sample 3与Sample 1/2不重复

**输出**:

- `base_gp_state.pth` - 模型与likelihood的state_dict
- `base_gp_lengthscales.json` - 长度尺度与敏感度排序
- `base_gp_subject_stats.json` - 被试标准化统计（均值/标准差）
- `base_gp_encodings.json` - 分类变量编码映射
- `base_gp_key_points.json` - 三个关键点坐标及预测值
- `design_space_scan.csv` - 设计空间逐点预测（mean, std）
- `base_gp_report.md` - 完整报告（模型结构、训练摘要、长度尺度、被试统计、关键点详情）

---

## 三阶段协同逻辑

```
Step 1 (采样设计)
    ↓ 生成采样方案
【用户执行实验】
    ↓ 收集响应数据
Step 2 (交互筛选 + λ估计)
    ↓ 输出Phase 2参数
【Phase 2主动学习】
    ↓ 可选：加载Base GP作为先验
Step 3 (Base GP + 关键点)
    ↓ 提供形状函数先验 + 三个初始采样点
【Phase 2精细化探索】
```

**关键输出汇总**:

- Step 1 → 采样CSV（实验执行依据）
- Step 2 → 交互对列表 + λ/γ调度（Phase 2核心参数）
- Step 3 → Base GP模型 + 三个关键点（Phase 2先验 + 初始点）
