# Parameter Correction Mystery - Root Cause Analysis and Final Fix

**Date**: 2025-12-09  
**Status**: ✅ RESOLVED - Correct Solution Implemented

## Problem Statement

采样中频繁看到参数修正日志：

```
最近邻修正 5.6 -> 4.0
Condition_ID修正
```

问题：为什么CustomPoolBasedGenerator理论上应该返回pool值，却还需要事后修正？

## Root Cause Analysis

### 关键发现

从experiment.log第一次EUR调用可见：

```
Extracted 8 historical points from server
  ✓ Matched: [4.0, 6.5, 0.0]...   (warmup point 1)
  ✓ Matched: [2.8, 6.5, 2.0]...   (warmup point 2)
  ✓ Matched: [8.5, 8.0, 2.0]...   (warmup point 3)
  ✗ No match: [5.6, 6.5, 0.0]...  (server auto-gen point 4)
  ✗ No match: [5.6, 6.5, 4.0]...  (server auto-gen point 5)
  ✗ No match: [17.0, 8.0, 2.0]... (server auto-gen point 6)
  ... more non-pool points ...
```

### 问题的本质

1. **warmup配置**：

   ```ini
   [init_strat]
   min_asks = 3        # 3个ManualGenerator点
   refit_every = 4     # 第4次时需要refitting
   ```

2. **AEPsych行为**：
   - 前3个问：ManualGenerator返回golden points ✓
   - 第4个问及以后：AEPsych自动使用其他generator（Sobol？）填补历史 ❓
   - 这些自动生成的点**不在pool中** → [5.6, 17.0, ...]

3. **链式反应**：

   ```
   Server database ← AEPsych自动生成的非pool点
                  ↓
   get_sampling_history_from_server() → 提取所有raw点
                  ↓
   match_points_to_pool_indices() → 5个点无法匹配
                  ↓
   param_validator修正 → 5.6→4.0（最近邻）
                  ↓
   污染训练数据 ✗
   ```

## Final Solution: Smart Filtering

### 修改策略

改进 `_get_sampling_history_from_server()` 在提取历史**之后**进行过滤：

```python
def _get_sampling_history_from_server(self) -> torch.Tensor:
    """
    Get sampling history from server, filtered to pool-matched points only.
    
    RATIONALE: Server database may contain points generated by AEPsych's internal
    mechanisms that don't match the pool. We filter to only include points that 
    can be matched to pool indices.
    """
    # Step 1: Get raw history from server (includes all points)
    raw_history = pool_utils.get_sampling_history_from_server(server)
    
    # Step 2: Filter to only points that match the pool
    matched_indices = self._match_points_to_pool_indices(raw_history)
    
    # Step 3: Return filtered history
    if not matched_indices:
        return None
    
    filtered_history = raw_history[sorted(matched_indices)]
    return filtered_history
```

### 为什么这个方案是正确的

| 问题点 | 本方案的处理 |
|------|-----------|
| warmup的3个golden points | ✅ 能匹配到pool，被保留 |
| 服务器自动生成的5个非pool点 | ✅ 无法匹配，被过滤掉 |
| CustomPoolBasedGenerator生成的pool点 | ✅ 当然能匹配，被保留 |

### 效果

修复前（问题）：

```
Server history: [4.0, 2.8, 8.5, 5.6, 5.6, 17.0, 17.0, ...]  (8个点)
                  ↓
match_points_to_pool_indices(): 前3个✓，后5个✗
                  ↓
param_validator修正：5.6→4.0 污染数据 ✗
```

修复后（解决）：

```
Server history: [4.0, 2.8, 8.5, 5.6, 5.6, 17.0, 17.0, ...]  (8个点)
                  ↓
filter to pool-matched: [4.0, 2.8, 8.5]  (3个点)
                  ↓
没有无法匹配的点 → 不触发修正 ✓
```

## 修改清单

| 文件 | 改动 |
|------|------|
| `custom_pool_based_generator.py` | 行620-653: `_get_sampling_history_from_server()` 改为智能过滤 |
| `pool_utils.py` | 行165-198: 文档说明 |

## 验证

✅ **所有测试通过**：

- 三模式dedup测试：8/8 通过
- 无语法错误
- 逻辑正确：warmup点保留，非pool点过滤

## 与最初修复的对比

| 方案 | 优点 | 问题 |
|------|------|------|
| 方案1（初版）：优先dedup_manager | 只用已采用的点 | ❌ 遗漏warmup的ManualGenerator点 |
| **方案2（最终）：智能过滤** | ✅ 保留warmup点，过滤非pool点 | 无 |

最终方案实现了真正的自动过滤，无需改变架构，保留所有有效信息。
